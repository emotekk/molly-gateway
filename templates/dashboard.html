<!DOCTYPE html>
<html>
<head>
    <title>Molly Gateway Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #0f111a 0%, #1a1c2e 100%);
            color: #e0e0e0; 
            display: flex; 
            justify-content: center; 
            padding: 20px;
            min-height: 100vh;
        }
        .container { 
            background: #1a1c2e; 
            padding: 40px; 
            border-radius: 16px; 
            width: 100%; 
            max-width: 900px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        
        .status-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 2px solid #2d314d; 
            padding-bottom: 20px; 
            margin-bottom: 30px;
        }
        h1 {
            font-size: 28px;
            color: #fff;
        }
        .status-tag { 
            padding: 8px 20px; 
            border-radius: 20px; 
            font-weight: bold; 
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .running { 
            background: #00c853; 
            color: white;
            animation: pulse 2s infinite;
        }
        .offline { 
            background: #ff5252; 
            color: white; 
        }
        .starting {
            background: #ff9800;
            color: white;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Device Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        .stat-card.green {
            background: linear-gradient(135deg, #00c853 0%, #00e676 100%);
        }
        .stat-number {
            font-size: 36px;
            font-weight: bold;
            color: white;
        }
        .stat-label {
            font-size: 13px;
            color: rgba(255,255,255,0.9);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 5px;
        }
        
        /* Devices Section */
        .devices-section {
            background: #252841;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
        }
        .devices-section h2 {
            color: #fff;
            font-size: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        .devices-section h2::before {
            content: "üì±";
            margin-right: 10px;
            font-size: 24px;
        }
        
        .device-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .device-item {
            background: #1a1c2e;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #00c853;
        }
        .device-info {
            flex: 1;
        }
        .device-name {
            font-size: 14px;
            color: #fff;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .device-uuid {
            font-size: 12px;
            color: #888;
            font-family: 'Courier New', monospace;
        }
        .device-meta {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
        }
        .device-actions {
            display: flex;
            gap: 8px;
        }
        .btn-remove {
            padding: 8px 16px;
            background: transparent;
            border: 2px solid #ff5252;
            color: #ff5252;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.2s;
        }
        .btn-remove:hover {
            background: rgba(255, 82, 82, 0.1);
        }
        .btn-remove:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        .empty-state-text {
            font-size: 16px;
            margin-bottom: 10px;
        }
        .empty-state-hint {
            font-size: 13px;
            color: #888;
        }
        
        .info-section {
            background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            color: white;
        }
        .info-section h2 {
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        .info-section h2::before {
            content: "üîó";
            margin-right: 10px;
            font-size: 24px;
        }
        .info-section p {
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 20px;
            opacity: 0.95;
        }
        
        .connection-box {
            background: rgba(255,255,255,0.15);
            padding: 20px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
            margin-bottom: 15px;
        }
        .connection-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.8;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }
        .connection-label::before {
            content: "üåê";
            margin-right: 6px;
        }
        .connection-url {
            font-family: 'Courier New', monospace;
            font-size: 16px;
            font-weight: bold;
            word-break: break-all;
            background: rgba(0,0,0,0.3);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
        }
        .url-hint {
            font-size: 12px;
            opacity: 0.85;
            line-height: 1.5;
        }
        
        .link-button {
            display: block;
            text-align: center;
            padding: 14px;
            background: white;
            color: #4f46e5;
            text-decoration: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 15px;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }
        .link-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255,255,255,0.3);
        }
        .link-button.secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 13px;
        }
        
        .info-banner {
            background: #252841;
            border-left: 4px solid #3b82f6;
            padding: 18px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.6;
        }
        .info-banner strong {
            color: #60a5fa;
            display: block;
            margin-bottom: 8px;
        }
        
        .action-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px; 
            margin-bottom: 25px;
        }
        .btn { 
            padding: 14px; 
            border-radius: 8px; 
            text-decoration: none; 
            font-weight: bold; 
            text-align: center; 
            border: none; 
            cursor: pointer; 
            font-size: 14px;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .btn-outline { 
            border: 2px solid #4f46e5; 
            color: #818cf8; 
            background: transparent; 
        }
        .btn-outline:hover:not(:disabled) {
            background: rgba(79, 70, 229, 0.1);
        }
        .btn-danger { 
            background: transparent; 
            color: #ff5252; 
            border: 2px solid #ff5252; 
        }
        .btn-danger:hover:not(:disabled) {
            background: rgba(255, 82, 82, 0.1);
        }
        
        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        #log-area { 
            background: #000; 
            color: #00ff00; 
            font-family: 'Courier New', monospace; 
            font-size: 11px; 
            padding: 20px; 
            border-radius: 8px; 
            height: 250px; 
            overflow-y: auto; 
            margin-top: 20px; 
            display: none;
            border: 2px solid #2d314d;
        }
        #log-area.active {
            display: block;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #2d314d;
            font-size: 13px;
            color: #666;
        }
        
        @media (max-width: 600px) {
            .container { padding: 25px; }
            h1 { font-size: 24px; }
            .action-grid { grid-template-columns: 1fr; }
            .device-item {
                flex-direction: column;
                align-items: flex-start;
            }
            .device-actions {
                margin-top: 10px;
                width: 100%;
            }
            .btn-remove {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="status-header">
            <h1>üõ°Ô∏è Gateway Dashboard</h1>
            <div id="statusTag" class="status-tag starting">Checking...</div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card green">
                <div class="stat-number" id="deviceCount">0</div>
                <div class="stat-label">Connected Devices</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="statusIcon">‚óè</div>
                <div class="stat-label">Gateway Status</div>
            </div>
        </div>

        <!-- Connected Devices -->
        <div class="devices-section">
            <h2>Connected Devices</h2>
            <div id="deviceList" class="device-list">
                <div class="empty-state">
                    <div class="empty-state-icon">üì±</div>
                    <div class="empty-state-text">No devices connected yet</div>
                    <div class="empty-state-hint">Register your first device using the gateway URL below</div>
                </div>
            </div>
        </div>

        <div class="info-banner">
            <strong>üí° Multiple Devices Supported</strong>
            This gateway can serve unlimited devices! Each person in your family can register their own phone or tablet. Just have everyone follow the registration steps below with the same gateway URL - each device will automatically get its own unique endpoint.
        </div>

        <div class="info-section">
            <h2>Register New Device</h2>
            <p>Use this URL to register any Molly device. Each device will get its own unique endpoint automatically.</p>
            
            <div class="connection-box">
                <div class="connection-label">Gateway URL (All Devices Use This)</div>
                <div class="connection-url" id="gatewayUrl">Loading...</div>
                <button onclick="copyUrl(this, 'tailscale')" class="link-button secondary">üìã Copy URL</button>
            </div>

            <a id="directLink" href="#" target="_blank" class="link-button">üì± Open Gateway</a>
        </div>

        <h3 style="color: #fff; margin-bottom: 15px; font-size: 18px;">üõ†Ô∏è Management Tools</h3>
        <div class="action-grid">
            <button onclick="refreshDevices()" class="btn btn-outline">üîÑ Refresh Devices</button>
            <button onclick="fetchLogs()" class="btn btn-outline">üìã View Logs</button>
            <a href="/download-config" class="btn btn-outline">üíæ Download Config</a>
            <button id="resetBtn" onclick="resetGateway()" class="btn btn-danger" style="grid-column: 1 / -1;">üóëÔ∏è Reset Gateway</button>
        </div>

        <div id="log-area"></div>
        
        <div class="footer">
            Molly Gateway ‚Ä¢ Private Push Notifications<br>
            <span id="networkInfo"></span>
        </div>
    </div>

    <script>
        let networkData = {};
        
        // Copy URL to clipboard
        function copyUrl(element, type) {
            const urlText = document.getElementById('gatewayUrl').textContent;
            
            if (urlText === 'Loading...' || urlText === 'Waiting for Tailscale...') {
                alert('URL not ready yet. Please wait a moment.');
                return;
            }
            
            navigator.clipboard.writeText(urlText).then(() => {
                const btn = element;
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ Copied!';
                btn.style.background = '#00c853';
                btn.style.borderColor = '#00c853';
                btn.style.color = 'white';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                    btn.style.borderColor = '';
                    btn.style.color = '';
                }, 2000);
            }).catch(err => {
                alert('Copy failed. Please copy manually: ' + urlText);
            });
        }
        
        // Update Status and Network Info
        function updateStatus() {
            fetch('/health').then(r => r.json()).then(data => {
                networkData = data;
                const tag = document.getElementById('statusTag');
                const status = data.status || 'unknown';
                
                tag.innerText = status.toUpperCase();
                tag.className = "status-tag";
                
                if (status === 'running') {
                    tag.classList.add('running');
                    document.getElementById('statusIcon').innerText = '‚úì';
                } else if (status === 'starting' || status === 'restarting') {
                    tag.classList.add('starting');
                    document.getElementById('statusIcon').innerText = '‚ãØ';
                } else {
                    tag.classList.add('offline');
                    document.getElementById('statusIcon').innerText = '‚úó';
                }
                
                // Update Tailscale URL
                const tailscaleIp = data.tailscale_ip;
                if (tailscaleIp && tailscaleIp !== 'unknown') {
                    const url = `http://${tailscaleIp}:8080`;
                    document.getElementById('gatewayUrl').textContent = url;
                    document.getElementById('directLink').href = url;
                } else {
                    document.getElementById('gatewayUrl').textContent = 'Waiting for Tailscale...';
                    document.getElementById('directLink').href = '#';
                }
                
                // Network info footer
                let infoText = [];
                if (data.local_ip && data.local_ip !== 'unknown') infoText.push(`Local: ${data.local_ip}`);
                if (tailscaleIp && tailscaleIp !== 'unknown') infoText.push(`Tailscale: ${tailscaleIp}`);
                if (data.hostname && data.hostname !== 'unknown') infoText.push(`Hostname: ${data.hostname}`);
                document.getElementById('networkInfo').textContent = infoText.join(' ‚Ä¢ ');
                
            }).catch(err => {
                console.error('Health check failed:', err);
                document.getElementById('statusTag').innerText = 'ERROR';
                document.getElementById('statusTag').className = 'status-tag offline';
            });
        }
        
        // Fetch and display devices
        function refreshDevices() {
            fetch('/devices').then(r => r.json()).then(data => {
                const count = data.count || 0;
                const devices = data.devices || [];
                
                document.getElementById('deviceCount').textContent = count;
                
                const listEl = document.getElementById('deviceList');
                
                if (count === 0) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üì±</div>
                            <div class="empty-state-text">No devices connected yet</div>
                            <div class="empty-state-hint">Register your first device using the gateway URL below</div>
                        </div>
                    `;
                } else {
                    listEl.innerHTML = devices.map((device, idx) => `
                        <div class="device-item">
                            <div class="device-info">
                                <div class="device-name">Device ${idx + 1} ${device.device_id !== 'Unknown' ? '(' + device.device_id + ')' : ''}</div>
                                <div class="device-uuid">${device.uuid}</div>
                                <div class="device-meta">
                                    Registered: ${formatDate(device.created)} 
                                    ${device.last_ping !== 'Never' ? '‚Ä¢ Last ping: ' + formatDate(device.last_ping) : ''}
                                </div>
                            </div>
                            <div class="device-actions">
                                <button class="btn-remove" onclick="removeDevice('${device.uuid}')">üóëÔ∏è Remove</button>
                            </div>
                        </div>
                    `).join('');
                }
            }).catch(err => {
                console.error('Failed to fetch devices:', err);
            });
        }
        
        // Format date for display
        function formatDate(timestamp) {
            if (!timestamp || timestamp === 'Never') return 'Never';
            try {
                const date = new Date(timestamp * 1000); // Unix timestamp to JS Date
                return date.toLocaleString();
            } catch {
                return timestamp;
            }
        }
        
        // Remove a device
        function removeDevice(uuid) {
            if (!confirm('Are you sure you want to remove this device?\n\nThe user will need to re-register their Molly app.')) {
                return;
            }
            
            fetch(`/devices/remove/${uuid}`, { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Device removed successfully');
                        refreshDevices();
                    } else {
                        alert('Failed to remove device: ' + data.message);
                    }
                })
                .catch(err => {
                    alert('Error removing device: ' + err.message);
                });
        }
        
        // Initial load
        updateStatus();
        refreshDevices();
        
        // Refresh every 10 seconds
        setInterval(updateStatus, 10000);
        setInterval(refreshDevices, 10000);

        function fetchLogs() {
            const area = document.getElementById('log-area');
            area.classList.add('active');
            area.innerText = "Fetching logs...\n";
            fetch('/logs').then(r => r.text()).then(text => {
                area.innerText = text || "No logs available yet.\n";
                area.scrollTop = area.scrollHeight;
            }).catch(err => {
                area.innerText = `Error fetching logs: ${err.message}\n`;
            });
        }

        function resetGateway() {
            if(confirm("‚ö†Ô∏è Are you sure?\n\nThis will:\n‚Ä¢ Stop the gateway\n‚Ä¢ Delete your configuration\n‚Ä¢ Remove ALL registered devices\n‚Ä¢ Erase all data\n\nYou'll need to set up again from scratch.")) {
                const btn = document.getElementById('resetBtn');
                const originalText = btn.innerHTML;
                
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner"></span>Resetting...';
                
                fetch('/reset-gateway', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            btn.innerHTML = '<span class="spinner"></span>Success! Reloading...';
                            setTimeout(() => location.reload(), 2000);
                        } else {
                            throw new Error(data.message || 'Reset failed');
                        }
                    })
                    .catch(err => {
                        alert('Reset failed: ' + err.message);
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    });
            }
        }
    </script>
</body>
</html>